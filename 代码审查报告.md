# ä»£ç å®¡æŸ¥æŠ¥å‘Š

## ä¸€ã€ä»£ç è§„èŒƒæ€§æ£€æŸ¥

### âœ… ä¼˜ç§€çš„æ–¹é¢

#### 1. å‘½åè§„èŒƒï¼ˆå®Œå…¨ç¬¦åˆï¼‰
- âœ… **ç±»å**ï¼šå¤§å†™å¼€å¤´ï¼ˆPascalCaseï¼‰
  - `GameController`, `CardModel`, `UndoManager` âœ“
- âœ… **å‡½æ•°å**ï¼šé©¼å³°å‘½åï¼ˆcamelCaseï¼‰
  - `startGame()`, `canMatch()`, `updateDisplay()` âœ“
- âœ… **ç§æœ‰æˆå‘˜**ï¼šä¸‹åˆ’çº¿å¼€å¤´
  - `_gameModel`, `_undoManager`, `_isAnimating` âœ“
- âœ… **å¸¸é‡**ï¼šk å¼€å¤´
  - `kCardMoveDuration`, `kDesignWidth` âœ“

#### 2. æ³¨é‡Šæ–‡æ¡£ï¼ˆå®Œå…¨ç¬¦åˆï¼‰
- âœ… **ç±»æ³¨é‡Š**ï¼šæ‰€æœ‰ç±»éƒ½æœ‰è¯¦ç»†çš„ JSDoc æ³¨é‡Š
- âœ… **æ–¹æ³•æ³¨é‡Š**ï¼šå…¬å…±æ–¹æ³•éƒ½æœ‰å‚æ•°å’Œè¿”å›å€¼è¯´æ˜
- âœ… **ä»£ç æ³¨é‡Š**ï¼šå…³é”®é€»è¾‘éƒ½æœ‰è¡Œå†…æ³¨é‡Š

#### 3. ä»£ç ç»“æ„ï¼ˆå®Œå…¨ç¬¦åˆï¼‰
- âœ… **MVC æ¶æ„**ï¼šèŒè´£åˆ†ç¦»æ¸…æ™°
- âœ… **å•ä¸€èŒè´£åŸåˆ™**ï¼šæ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- âœ… **ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡æ„é€ å‡½æ•°å’Œå‚æ•°ä¼ é€’ä¾èµ–

### âš ï¸ éœ€è¦æ”¹è¿›çš„æ–¹é¢

#### 1. ç±»å‹å®‰å…¨æ€§
```typescript
// å½“å‰ä»£ç ï¼ˆGameController.ts:143ï¼‰
if (!cardView || !cardView.node.parent) return;
```

**é—®é¢˜**ï¼š`cardView.node` å¯èƒ½ä¸º undefinedï¼ˆè™½ç„¶å®é™…ä¸ä¼šï¼Œä½† TypeScript ç±»å‹ç³»ç»Ÿæ— æ³•ç¡®è®¤ï¼‰

**å»ºè®®**ï¼š
```typescript
// æ”¹è¿›æ–¹æ¡ˆ1ï¼šæ·»åŠ éç©ºæ–­è¨€
if (!cardView?.node?.parent) return;

// æ”¹è¿›æ–¹æ¡ˆ2ï¼šæ›´æ˜ç¡®çš„æ£€æŸ¥
if (!cardView) return;
if (!cardView.node) return;
if (!cardView.node.parent) return;
```

#### 2. é­”æ³•æ•°å­—
```typescript
// CardView.ts:161
numberNode.setPosition(new Vec3(0, 30, 0));
suitNode.setPosition(new Vec3(0, -40, 0));
```

**é—®é¢˜**ï¼šç¡¬ç¼–ç çš„æ•°å­—ï¼Œéš¾ä»¥ç»´æŠ¤

**å»ºè®®**ï¼š
```typescript
// åœ¨ Constants.ts ä¸­å®šä¹‰
static readonly kCardNumberOffsetY: number = 30;
static readonly kCardSuitOffsetY: number = -40;

// ä½¿ç”¨å¸¸é‡
numberNode.setPosition(new Vec3(0, Constants.kCardNumberOffsetY, 0));
suitNode.setPosition(new Vec3(0, Constants.kCardSuitOffsetY, 0));
```

## äºŒã€æœ€ä½³å®è·µæ£€æŸ¥

### âœ… éµå¾ªçš„æœ€ä½³å®è·µ

#### 1. ä¾èµ–å€’ç½®åŸåˆ™
```typescript
// GameController.ts
private _undoManager: UndoManager = new UndoManager();
// âœ“ ä¾èµ–å…·ä½“å®ç°ï¼Œä½† UndoManager æ˜¯ç®€å•çš„æ•°æ®ç»“æ„ï¼Œå¯æ¥å—
```

#### 2. å¼€é—­åŸåˆ™
```typescript
// CardMatchService.ts
static canMatch(baseCard: CardModel, targetCard: CardModel): boolean {
    // âœ“ æ˜“äºæ‰©å±•æ–°çš„åŒ¹é…è§„åˆ™
}
```

#### 3. å•ä¸€èŒè´£åŸåˆ™
- âœ… `CardMatchService` åªè´Ÿè´£åŒ¹é…åˆ¤æ–­
- âœ… `UndoManager` åªè´Ÿè´£å›é€€è®°å½•ç®¡ç†
- âœ… `CardView` åªè´Ÿè´£å¡ç‰Œæ˜¾ç¤º

#### 4. æ— çŠ¶æ€æœåŠ¡
```typescript
// CardMatchService.ts
export class CardMatchService {
    // âœ“ æ— æˆå‘˜å˜é‡ï¼Œçº¯é™æ€æ–¹æ³•
    static canMatch(...) { }
}
```

### âš ï¸ å¯ä»¥æ”¹è¿›çš„æœ€ä½³å®è·µ

#### 1. é”™è¯¯å¤„ç†ä¸å¤Ÿå®Œå–„
```typescript
// GameController.ts:86
if (!card) {
    Logger.warn('stackCards empty: cannot init base card');
    return; // âš ï¸ ä»…è®°å½•è­¦å‘Šï¼Œæ²¡æœ‰é”™è¯¯æ¢å¤æœºåˆ¶
}
```

**å»ºè®®**ï¼š
```typescript
if (!card) {
    Logger.error('Fatal: stackCards empty, cannot initialize game');
    // æ˜¾ç¤ºé”™è¯¯æç¤ºç»™ç”¨æˆ·
    this.gameView.showError('å…³å¡é…ç½®é”™è¯¯ï¼šç¼ºå°‘å¡ç‰Œ');
    // æˆ–è€…å›é€€åˆ°ä¸»èœå•
    throw new Error('Invalid level configuration');
}
```

#### 2. ç¼ºå°‘è¾“å…¥éªŒè¯
```typescript
// CardMatchService.ts:16
static canMatch(baseCard: CardModel, targetCard: CardModel): boolean {
    if (!baseCard || !targetCard) {
        return false; // âš ï¸ ç®€å•è¿”å› falseï¼Œè°ƒç”¨è€…ä¸çŸ¥é“å…·ä½“åŸå› 
    }
}
```

**å»ºè®®**ï¼š
```typescript
static canMatch(baseCard: CardModel, targetCard: CardModel): boolean {
    if (!baseCard) {
        Logger.warn('canMatch: baseCard is null');
        return false;
    }
    if (!targetCard) {
        Logger.warn('canMatch: targetCard is null');
        return false;
    }
    // ... å…¶ä»–é€»è¾‘
}
```

#### 3. ç¼ºå°‘è¾¹ç•Œæ£€æŸ¥
```typescript
// GameController.ts:289
return this._gameModel.stackCards.length > 0 
    ? this._gameModel.stackCards.pop()! 
    : null;
```

**é—®é¢˜**ï¼šä½¿ç”¨äº†éç©ºæ–­è¨€ `!`ï¼Œè™½ç„¶é€»è¾‘ä¸Šå®‰å…¨ï¼Œä½†ä¸å¤Ÿæ˜ç¡®

**å»ºè®®**ï¼š
```typescript
if (this._gameModel.stackCards.length === 0) return null;
const card = this._gameModel.stackCards.pop();
if (!card) {
    Logger.warn('Unexpected: pop returned undefined');
    return null;
}
return card;
```

## ä¸‰ã€æ€§èƒ½é—®é¢˜æ£€æŸ¥

### âœ… æ€§èƒ½ä¼˜åŒ–è‰¯å¥½çš„æ–¹é¢

#### 1. ä½¿ç”¨åŠ¨ç”»é”
```typescript
// GameController.ts:46
private _isAnimating: boolean = false;
// âœ“ é˜²æ­¢åŠ¨ç”»æœŸé—´çš„é‡å¤æ“ä½œï¼Œé¿å…çŠ¶æ€æ··ä¹±
```

#### 2. èµ„æºé¢„åŠ è½½
```typescript
// GameController.ts:56
await CardResService.preload();
// âœ“ æå‰åŠ è½½æ‰€æœ‰èµ„æºï¼Œé¿å…æ¸¸æˆè¿‡ç¨‹ä¸­å¡é¡¿
```

#### 3. èµ„æºç¼“å­˜
```typescript
// CardResService.ts:11
private static _cache: Map<string, SpriteFrame> = new Map();
// âœ“ ç¼“å­˜å·²åŠ è½½çš„èµ„æºï¼Œé¿å…é‡å¤åŠ è½½
```

### âš ï¸ æ€§èƒ½é—®é¢˜å’Œä¼˜åŒ–å»ºè®®

#### 1. é¢‘ç¹çš„æ•°ç»„éå†
```typescript
// GameController.ts:307-313
private _findCardById(cardId: number): CardModel | null {
    const inPlayfield = this._gameModel.playfieldCards.find(c => c.id === cardId);
    if (inPlayfield) return inPlayfield;
    const inStack = this._gameModel.stackCards.find(c => c.id === cardId);
    if (inStack) return inStack;
    const inWaste = this._gameModel.wasteCards.find(c => c.id === cardId);
    if (inWaste) return inWaste;
    return null;
}
```

**é—®é¢˜**ï¼šO(n) æ—¶é—´å¤æ‚åº¦ï¼Œå¦‚æœå¡ç‰Œæ•°é‡å¤šä¼šå½±å“æ€§èƒ½

**ä¼˜åŒ–å»ºè®®**ï¼š
```typescript
// åœ¨ GameModel ä¸­æ·»åŠ  Map
private _cardIdMap: Map<number, CardModel> = new Map();

// åˆå§‹åŒ–æ—¶å»ºç«‹æ˜ å°„
public buildCardIndex(): void {
    this._cardIdMap.clear();
    this.playfieldCards.forEach(c => this._cardIdMap.set(c.id, c));
    this.stackCards.forEach(c => this._cardIdMap.set(c.id, c));
    this.wasteCards.forEach(c => this._cardIdMap.set(c.id, c));
}

// O(1) æŸ¥æ‰¾
private _findCardById(cardId: number): CardModel | null {
    return this._gameModel._cardIdMap.get(cardId) ?? null;
}
```

#### 2. åŠ¨æ€åˆ›å»ºèŠ‚ç‚¹
```typescript
// CardView.ts:158-169
private _ensureOverlaySprites(): void {
    if (this._numberSprite && this._suitSprite) return;
    const numberNode = new Node('Number');
    const suitNode = new Node('Suit');
    // âš ï¸ æ¯æ¬¡åˆå§‹åŒ–éƒ½åˆ›å»ºæ–°èŠ‚ç‚¹
}
```

**ä¼˜åŒ–å»ºè®®**ï¼šä½¿ç”¨å¯¹è±¡æ± 
```typescript
// åˆ›å»ºå¯¹è±¡æ± ç®¡ç†å™¨
class CardViewPool {
    private _pool: CardView[] = [];
    
    get(): CardView {
        return this._pool.pop() || this._createNew();
    }
    
    put(view: CardView): void {
        view.reset();
        this._pool.push(view);
    }
    
    private _createNew(): CardView {
        // åˆ›å»ºæ–°çš„ CardView
    }
}
```

#### 3. ç¼ºå°‘èŠ‚ç‚¹å¤ç”¨
```typescript
// PlayfieldView.ts å’Œ StackView.ts
// âš ï¸ å½“å‰å®ç°æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„å¡ç‰ŒèŠ‚ç‚¹ï¼Œæ²¡æœ‰å¤ç”¨
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- å®ç°å¡ç‰ŒèŠ‚ç‚¹æ± 
- æ¸¸æˆç»“æŸæ—¶å›æ”¶èŠ‚ç‚¹åˆ°æ± ä¸­
- ä¸‹æ¬¡ä½¿ç”¨æ—¶ä»æ± ä¸­å–å‡º

#### 4. å­—ç¬¦ä¸²æ‹¼æ¥
```typescript
// CardResService.ts:86
const path = `poker_res/number/big_${color}_${sym}`;
// âš ï¸ é¢‘ç¹çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆè™½ç„¶å½±å“ä¸å¤§ï¼Œä½†å¯ä»¥ä¼˜åŒ–ï¼‰
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```typescript
// é¢„å®šä¹‰è·¯å¾„æ¨¡æ¿
private static readonly PATH_TEMPLATES = {
    bigNumber: (color: string, sym: string) => `poker_res/number/big_${color}_${sym}`,
    suit: (name: string) => `poker_res/suits/${name}`
};

// æˆ–è€…ä½¿ç”¨å¸¸é‡æ˜ å°„
private static readonly SUIT_PATHS: Record<CardSuitType, string> = {
    [CardSuitType.CLUBS]: 'poker_res/suits/club',
    [CardSuitType.DIAMONDS]: 'poker_res/suits/diamond',
    [CardSuitType.HEARTS]: 'poker_res/suits/heart',
    [CardSuitType.SPADES]: 'poker_res/suits/spade',
};
```

## å››ã€å®‰å…¨æ¼æ´æ£€æŸ¥

### âœ… å®‰å…¨æ€§è‰¯å¥½çš„æ–¹é¢

#### 1. è¾“å…¥éªŒè¯
```typescript
// GameController.ts:107
if (this._isAnimating || !this._gameModel) return;
// âœ“ æ£€æŸ¥çŠ¶æ€é”å’Œç©ºæŒ‡é’ˆ
```

#### 2. è¾¹ç•Œæ£€æŸ¥
```typescript
// GameController.ts:282-284
return this._gameModel.stackCards.length > 0
    ? this._gameModel.stackCards[this._gameModel.stackCards.length - 1]
    : null;
// âœ“ æ£€æŸ¥æ•°ç»„é•¿åº¦
```

#### 3. æ•°æ®å°è£…
```typescript
// CardModel.ts
public id: number;
// âš ï¸ å…¬å…±å­—æ®µï¼Œä½†åœ¨æ¸¸æˆåœºæ™¯ä¸‹å¯æ¥å—
```

### âš ï¸ æ½œåœ¨å®‰å…¨é—®é¢˜

#### 1. ç¼ºå°‘æ•°æ®éªŒè¯
```typescript
// GameModel.ts - deserialize
public static deserialize(data: any): CardModel {
    // âš ï¸ ç›´æ¥ä½¿ç”¨å¤–éƒ¨æ•°æ®ï¼Œæ²¡æœ‰éªŒè¯
    const card = new CardModel(
        data.id,      // å¦‚æœ data.id æ˜¯å­—ç¬¦ä¸²æˆ–è´Ÿæ•°ï¼Ÿ
        data.face,    // å¦‚æœ data.face ä¸æ˜¯æœ‰æ•ˆæšä¸¾å€¼ï¼Ÿ
        data.suit,    // å¦‚æœ data.suit ä¸æ˜¯æœ‰æ•ˆæšä¸¾å€¼ï¼Ÿ
        // ...
    );
}
```

**å®‰å…¨å»ºè®®**ï¼š
```typescript
public static deserialize(data: any): CardModel {
    // éªŒè¯æ•°æ®ç±»å‹
    if (typeof data.id !== 'number' || data.id < 0) {
        throw new Error('Invalid card id');
    }
    
    // éªŒè¯æšä¸¾å€¼
    if (!Object.values(CardFaceType).includes(data.face)) {
        throw new Error('Invalid card face');
    }
    
    if (!Object.values(CardSuitType).includes(data.suit)) {
        throw new Error('Invalid card suit');
    }
    
    // éªŒè¯ä½ç½®
    if (!data.position || typeof data.position.x !== 'number') {
        throw new Error('Invalid position');
    }
    
    // åˆ›å»ºå®ä¾‹
    return new CardModel(/* ... */);
}
```

#### 2. åŸå‹æ±¡æŸ“é£é™©
```typescript
// LevelConfig.ts - ä½¿ç”¨ any ç±»å‹
public serialize(): any {
    return {
        // âš ï¸ è¿”å› any ç±»å‹ï¼Œå¯èƒ½è¢«æ±¡æŸ“
    };
}
```

**å»ºè®®**ï¼š
```typescript
// å®šä¹‰æ˜ç¡®çš„æ¥å£
export interface CardModelData {
    id: number;
    face: CardFaceType;
    suit: CardSuitType;
    position: { x: number; y: number; z: number };
    isFaceUp: boolean;
}

public serialize(): CardModelData {
    return {
        id: this.id,
        face: this.face,
        suit: this.suit,
        position: { x: this.position.x, y: this.position.y, z: this.position.z },
        isFaceUp: this.isFaceUp
    };
}
```

#### 3. å›è°ƒå‡½æ•°å®‰å…¨
```typescript
// CardView.ts:38
public init(cardModel: CardModel, onClickCallback: (cardId: number) => void): void {
    this._onClickCallback = onClickCallback;
    // âš ï¸ æ²¡æœ‰æ£€æŸ¥å›è°ƒæ˜¯å¦ä¸º null
}

// CardView.ts:113
private _onCardClick(event: EventTouch): void {
    if (this._cardModel && this._onClickCallback && ...) {
        this._onClickCallback(this._cardModel.id);
    }
}
```

**å½“å‰å·²ç»æœ‰æ£€æŸ¥ï¼Œä½†å»ºè®®æ›´æ˜ç¡®**ï¼š
```typescript
public init(cardModel: CardModel, onClickCallback: (cardId: number) => void): void {
    if (!cardModel) {
        throw new Error('cardModel cannot be null');
    }
    if (typeof onClickCallback !== 'function') {
        throw new Error('onClickCallback must be a function');
    }
    this._cardModel = cardModel;
    this._onClickCallback = onClickCallback;
    // ...
}
```

#### 4. æ•°ç»„è¶Šç•Œ
```typescript
// GameController.ts:277
this._gameModel.playfieldCards.splice(idx, 1);
// âœ“ å·²ç»æ£€æŸ¥äº† idx >= 0ï¼Œå®‰å…¨
```

## äº”ã€æ€»ä½“è¯„åˆ†

### ä»£ç è´¨é‡è¯„åˆ†

| è¯„ä¼°é¡¹ | å¾—åˆ† | è¯´æ˜ |
|--------|------|------|
| ä»£ç è§„èŒƒæ€§ | 95/100 | å‘½åè§„èŒƒã€æ³¨é‡Šå®Œå–„ï¼Œä»…æœ‰å°‘é‡é­”æ³•æ•°å­— |
| æ¶æ„è®¾è®¡ | 95/100 | MVC æ¶æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»æ˜ç¡® |
| æœ€ä½³å®è·µ | 85/100 | éµå¾ªå¤§éƒ¨åˆ†æœ€ä½³å®è·µï¼Œé”™è¯¯å¤„ç†å¯æ”¹è¿› |
| æ€§èƒ½ä¼˜åŒ– | 80/100 | æœ‰åŸºæœ¬ä¼˜åŒ–ï¼Œä½†ç¼ºå°‘å¯¹è±¡æ± å’Œç´¢å¼•ä¼˜åŒ– |
| å®‰å…¨æ€§ | 85/100 | åŸºæœ¬å®‰å…¨ï¼Œä½†ç¼ºå°‘è¾“å…¥éªŒè¯å’Œæ•°æ®æ ¡éªŒ |
| **æ€»åˆ†** | **88/100** | **ä¼˜ç§€** |

### ä¼˜å…ˆçº§æ”¹è¿›å»ºè®®

#### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»æ”¹è¿›ï¼‰

1. **æ·»åŠ æ•°æ®éªŒè¯**
   - åœ¨ `deserialize()` æ–¹æ³•ä¸­æ·»åŠ æ•°æ®ç±»å‹å’ŒèŒƒå›´æ£€æŸ¥
   - é˜²æ­¢æ— æ•ˆæ•°æ®å¯¼è‡´ç¨‹åºå´©æºƒ

2. **æ”¹è¿›é”™è¯¯å¤„ç†**
   - å…³é”®é”™è¯¯åº”è¯¥æŠ›å‡ºå¼‚å¸¸æˆ–æ˜¾ç¤ºç»™ç”¨æˆ·
   - ä¸åº”è¯¥ä»…è®°å½•æ—¥å¿—åç»§ç»­æ‰§è¡Œ

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®æ”¹è¿›ï¼‰

3. **æ€§èƒ½ä¼˜åŒ–**
   - å®ç°å¡ç‰Œ ID çš„ Map ç´¢å¼•ï¼Œæé«˜æŸ¥æ‰¾æ•ˆç‡
   - è€ƒè™‘å®ç°å¯¹è±¡æ± ï¼ˆå¦‚æœå¡ç‰Œæ•°é‡å¾ˆå¤šï¼‰

4. **æ¶ˆé™¤é­”æ³•æ•°å­—**
   - å°†ç¡¬ç¼–ç çš„æ•°å­—æå–åˆ°å¸¸é‡ä¸­
   - æé«˜ä»£ç å¯ç»´æŠ¤æ€§

#### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰æ”¹è¿›ï¼‰

5. **ç±»å‹å®‰å…¨æ€§**
   - ä½¿ç”¨å¯é€‰é“¾æ“ä½œç¬¦ `?.` æé«˜ç±»å‹å®‰å…¨
   - å‡å°‘éç©ºæ–­è¨€ `!` çš„ä½¿ç”¨

6. **ä»£ç æ³¨é‡Š**
   - ä¸ºå¤æ‚ç®—æ³•æ·»åŠ æ›´è¯¦ç»†çš„æ³¨é‡Š
   - æ·»åŠ ç¤ºä¾‹ä»£ç 

## å…­ã€æ”¹è¿›ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ”¹è¿›çš„æ•°æ®éªŒè¯

```typescript
// CardModel.ts - æ”¹è¿›å
public static deserialize(data: any): CardModel {
    // éªŒè¯å¿…éœ€å­—æ®µ
    this._validateDeserializeData(data);
    
    const card = new CardModel(
        data.id,
        data.face,
        data.suit,
        new Vec3(data.position.x, data.position.y, data.position.z ?? 0),
        data.isFaceUp
    );
    return card;
}

private static _validateDeserializeData(data: any): void {
    if (!data) {
        throw new Error('Card data cannot be null');
    }
    
    if (typeof data.id !== 'number' || data.id < 0) {
        throw new Error(`Invalid card id: ${data.id}`);
    }
    
    if (!this._isValidFaceType(data.face)) {
        throw new Error(`Invalid card face: ${data.face}`);
    }
    
    if (!this._isValidSuitType(data.suit)) {
        throw new Error(`Invalid card suit: ${data.suit}`);
    }
    
    if (!data.position || typeof data.position.x !== 'number' || typeof data.position.y !== 'number') {
        throw new Error('Invalid position data');
    }
    
    if (typeof data.isFaceUp !== 'boolean') {
        throw new Error('Invalid isFaceUp value');
    }
}

private static _isValidFaceType(face: any): boolean {
    return typeof face === 'number' && face >= CardFaceType.ACE && face <= CardFaceType.KING;
}

private static _isValidSuitType(suit: any): boolean {
    return typeof suit === 'number' && suit >= CardSuitType.CLUBS && suit <= CardSuitType.SPADES;
}
```

### ç¤ºä¾‹2ï¼šæ€§èƒ½ä¼˜åŒ– - å¡ç‰Œç´¢å¼•

```typescript
// GameModel.ts - æ·»åŠ ç´¢å¼•
export class GameModel {
    public playfieldCards: CardModel[] = [];
    public stackCards: CardModel[] = [];
    public wasteCards: CardModel[] = [];
    
    // æ·»åŠ ç´¢å¼•
    private _cardIndex: Map<number, CardModel> = new Map();
    
    /**
     * é‡å»ºå¡ç‰Œç´¢å¼•
     */
    public rebuildCardIndex(): void {
        this._cardIndex.clear();
        
        this.playfieldCards.forEach(card => this._cardIndex.set(card.id, card));
        this.stackCards.forEach(card => this._cardIndex.set(card.id, card));
        this.wasteCards.forEach(card => this._cardIndex.set(card.id, card));
    }
    
    /**
     * é€šè¿‡ ID æŸ¥æ‰¾å¡ç‰Œï¼ˆO(1) æ—¶é—´å¤æ‚åº¦ï¼‰
     */
    public findCardById(cardId: number): CardModel | null {
        return this._cardIndex.get(cardId) ?? null;
    }
}

// GameController.ts - ä½¿ç”¨ç´¢å¼•
private _findCardById(cardId: number): CardModel | null {
    if (!this._gameModel) return null;
    return this._gameModel.findCardById(cardId);
}
```

### ç¤ºä¾‹3ï¼šæ¶ˆé™¤é­”æ³•æ•°å­—

```typescript
// Constants.ts - æ·»åŠ å¸¸é‡
export class Constants {
    // ... ç°æœ‰å¸¸é‡
    
    /** å¡ç‰Œæ•°å­—åç§»Y */
    static readonly kCardNumberOffsetY: number = 30;
    /** å¡ç‰ŒèŠ±è‰²åç§»Y */
    static readonly kCardSuitOffsetY: number = -40;
    /** ç¿»ç‰ŒåŠ¨ç”»æ—¶é•¿ */
    static readonly kCardFlipDuration: number = 0.15;
}

// CardView.ts - ä½¿ç”¨å¸¸é‡
private _ensureOverlaySprites(): void {
    // ...
    numberNode.setPosition(new Vec3(0, Constants.kCardNumberOffsetY, 0));
    suitNode.setPosition(new Vec3(0, Constants.kCardSuitOffsetY, 0));
}

public playFlipAnimation(callback?: () => void): void {
    tween(this.node)
        .to(Constants.kCardFlipDuration, { scale: new Vec3(0, 1, 1) })
        .call(() => {
            this.updateDisplay();
        })
        .to(Constants.kCardFlipDuration, { scale: new Vec3(1, 1, 1) })
        .call(() => {
            if (callback) callback();
        })
        .start();
}
```

## ä¸ƒã€æ€»ç»“

### ä»£ç è´¨é‡æ€»ç»“

æœ¬é¡¹ç›®ä»£ç è´¨é‡**æ€»ä½“ä¼˜ç§€**ï¼Œè¾¾åˆ°ç”Ÿäº§ç¯å¢ƒæ ‡å‡†ï¼š

âœ… **ä¼˜ç‚¹**ï¼š
- æ¶æ„è®¾è®¡æ¸…æ™°ï¼ŒMVC åˆ†å±‚æ˜ç¡®
- ä»£ç è§„èŒƒæ€§é«˜ï¼Œå‘½åå’Œæ³¨é‡Šå®Œå–„
- åŸºæœ¬çš„æ€§èƒ½ä¼˜åŒ–å’Œå®‰å…¨æªæ–½åˆ°ä½
- éµå¾ªå¤§éƒ¨åˆ†è½¯ä»¶å·¥ç¨‹æœ€ä½³å®è·µ

âš ï¸ **éœ€è¦æ”¹è¿›**ï¼š
- æ•°æ®éªŒè¯ä¸å¤Ÿä¸¥æ ¼
- é”™è¯¯å¤„ç†æœºåˆ¶å¯ä»¥æ›´å®Œå–„
- æ€§èƒ½ä¼˜åŒ–è¿˜æœ‰æå‡ç©ºé—´ï¼ˆå¯¹è±¡æ± ã€ç´¢å¼•ï¼‰
- éƒ¨åˆ†é­”æ³•æ•°å­—éœ€è¦æå–ä¸ºå¸¸é‡

### æ”¹è¿›ä¼˜å…ˆçº§

1. **ç«‹å³æ”¹è¿›**ï¼šæ•°æ®éªŒè¯ã€é”™è¯¯å¤„ç†
2. **çŸ­æœŸæ”¹è¿›**ï¼šæ€§èƒ½ä¼˜åŒ–ã€æ¶ˆé™¤é­”æ³•æ•°å­—
3. **é•¿æœŸæ”¹è¿›**ï¼šä»£ç é‡æ„ã€å¢åŠ å•å…ƒæµ‹è¯•

### å»ºè®®

å¯¹äºå½“å‰é¡¹ç›®é˜¶æ®µï¼Œä»£ç è´¨é‡å·²ç»è¶³å¤Ÿå¥½ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å»ºè®®ï¼š

1. åœ¨æ‰©å±•åŠŸèƒ½å‰ï¼Œå…ˆå®ç°é«˜ä¼˜å…ˆçº§çš„æ”¹è¿›
2. å¦‚æœå¡ç‰Œæ•°é‡å¢åŠ ï¼Œä¼˜å…ˆå®ç°æ€§èƒ½ä¼˜åŒ–
3. æ·»åŠ å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿ä»£ç ç¨³å®šæ€§

---

**è¯„çº§**ï¼šâ­â­â­â­â˜† (4.5/5 æ˜Ÿ)
**ç»“è®º**ï¼šä»£ç è´¨é‡ä¼˜ç§€ï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨

